<!-- the current directory is templates/ -->
{% extends 'layout/base.html' %}
{% load static %}
{% load custom_tag %}

{% block title %}
    | Dashboard
{% endblock %}


{% block css %}
    <style>
        .inner-banner {
            background: url({% static "images/banner4.jpeg" %}) no-repeat center;
            background-size: cover;
            -webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
            -ms-background-size: cover;
            position: relative;
            z-index: 0;
        }
    </style>
{% endblock %}

{% block banner %}
    <!--/inner-page-->
    <div class="inner-banner py-5">
        <section class="w3l-breadcrumb text-left py-sm-5 ">
            <div class="container">
                <div class="w3breadcrumb-gids">
                    <div class="w3breadcrumb-left text-left">
                        <h2 class="inner-w3-title mt-sm-5 mt-4">
                            Dashboard </h2>

                    </div>
                    <div class="w3breadcrumb-right">
                        <ul class="breadcrumbs-custom-path">
                            <li><a href="{% url 'index' %}">Home</a></li>
                            <li class="active"><span class="fas fa-angle-double-right mx-2"></span> Dashboard</li>
                        </ul>
                    </div>
                </div>

            </div>
        </section>
    </div>
    <!--//inner-page-->
{% endblock %}

{% block contents %}
    <!--/download-section-->
    <div class="w3l-faq-block py-5" id="faq">
        <div class="container content-gd py-lg-5">
            <div class="row mt-3">
                <div class="col-lg-6 faqw3-right pe-lg-5">
                    <div class="faqw3content text-left">
                        <h6 class="title-subw3hny mb-1 text-left">Data Source</h6>
                        <h3 class="title-w3l mb-2">数据来源</h3>
                    </div>
                    <p class="mb-3">
                        为了进行有效的潮汐预报，临海国家大多会在其主要港口设置潮汐测量站，以收集足够的用于预报的观测数据。
                        我们本次研究使用的数据来源于爱尔兰海洋研究所运营的实时潮汐监测网络（The Irish National Tide Gauge
                        Network，
                        INTGN）。
                        该潮汐检测网络收集的数据维度包括：气象站（ID）、日期时间（时间戳格式为yyyy-mm-ddThh:mm:ss）、天文潮水位（最低天文潮位
                        [LAT]以上的海平面，单位：m）和马林头水位（与气象基准Malin Head相关的水位，m）。
                        用户下载数据时可以设置表计、时间段等条件进行筛选，并获得多种输出文件类型。最新的实时数据也可从FTP站点获取，
                        参见<a
                            href="http://www.marine.ie/site-area/data-services/real-time-observations/tidal-observations-0"
                            style="color: var(--secondary-color);">www.irishtides.ie</a>。
                        用户可以从该站点上获得更多的爱尔兰特定沿海位置的海平面、海水温度和大气压力监测信息。
                    </p>

                </div>
                <div class="col-lg-6 faqw3-left">
                    <img src="{% static 'images/mi_logo.gif' %}" alt="" class="img-fluid radius-image">
                    <div class="accordion" id="accordionExample">
                        <div class="accordion-item">
                            <h4 class="accordion-header" id="headingOne">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    01. CSV
                                </button>
                            </h4>
                            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne"
                                 data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <i class="fas fa-download" style="font-size: 1.75rem"></i>
                                    <a target="_blank"
                                       href="https://erddap.marine.ie/erddap/tabledap/IrishNationalTideGaugeNetwork.html"
                                       style="color: var(--secondary-color);">https://erddap.marine.ie/erddap/tabledap/IrishNationalTideGaugeNetwork.html</a>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h4 class="accordion-header" id="headingTwo">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    02. ISO 19156:2011 Observations and Measurements XML
                                </button>
                            </h4>
                            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo"
                                 data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <i class="fas fa-file-code" style="font-size: 1.75rem"></i><br>
                                    <a target="_blank"
                                       href="https://iemarinedata.blob.core.windows.net/observations-and-measurements/ie_marine_data__dataset_2774.xml"
                                       style="color: var(--secondary-color);">https://iemarinedata.blob.core.windows.net/observations-and-measurements/ie_marine_data__dataset_2774.xml</a>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h4 class="accordion-header" id="headingThree">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseThree" aria-expanded="false"
                                        aria-controls="collapseThree">
                                    03. JSON
                                </button>
                            </h4>
                            <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree"
                                 data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <i class="fas fa-download" style="font-size: 1.75rem"></i>
                                    <a target="_blank"
                                       href="https://erddap.marine.ie/erddap/tabledap/IrishNationalTideGaugeNetwork.html"
                                       style="color: var(--secondary-color);">https://erddap.marine.ie/erddap/tabledap/IrishNationalTideGaugeNetwork.html</a>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h4 class="accordion-header" id="headingFourth">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseFourth" aria-expanded="false"
                                        aria-controls="collapseFourth">
                                    04. NetCDF
                                </button>
                            </h4>
                            <div id="collapseFourth" class="accordion-collapse collapse" aria-labelledby="headingFourth"
                                 data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <i class="fas fa-download" style="font-size: 1.75rem"></i>
                                    <a target="_blank"
                                       href="https://erddap.marine.ie/erddap/tabledap/IrishNationalTideGaugeNetwork.html "
                                       style="color: var(--secondary-color);">https://erddap.marine.ie/erddap/tabledap/IrishNationalTideGaugeNetwork.html</a>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h4 class="accordion-header" id="headingFifth">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseFifth" aria-expanded="false"
                                        aria-controls="collapseFifth">
                                    05. Marine Institute Home Page
                                </button>
                            </h4>
                            <div id="collapseFifth" class="accordion-collapse collapse" aria-labelledby="headingFifth"
                                 data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <i class="fas fa-link" style="font-size: 1.75rem"></i>
                                    <a target="_blank" href="http://www.marine.ie"
                                       style="color: var(--secondary-color);">http://www.marine.ie</a>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>
    <!-- //download-section -->

    <!--/Location Distribution of Each Site-->
    <section class="w3l-servicesblock py-5" id="progress">
        <div class="container py-lg-5 py-md-4 py-2">
            <div class="row">
                <div class="col-lg-6 mb-lg-0 mb-5 pe-lg-5">
                    <h6 class="title-subw3hny mb-1">Location Distribution of Each Site</h6>
                    <h3 class="title-w3l">站点分布</h3>
                    <p class="mb-3">
                        我们选取了爱尔兰海岸线上的5个站点的数据进行我们的模型通用性和泛化能力分析。五个站点的位置分布如图所示。
                    </p>
                    <div class="mt-md-4 mt-3">
                        <table class="table table-hover">
                            <thead>

                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Site</th>
                                <th scope="col">Latitude (°)</th>
                                <th scope="col">Longitude (°)</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for row in siteinfo %}
                                <tr>
                                    <th scope="row">{{ row | add:1 }}</th>
                                    <td>{{ siteinfo| get_v:row | get_v:"Site" }}</td>
                                    <td>{{ siteinfo| get_v:row | get_v:"Latitude" | floatformat:4 }}</td>
                                    <td>{{ siteinfo| get_v:row | get_v:"Longitude" | floatformat:4 }}</td>
                                </tr>
                            {% endfor %}

                            </tbody>
                        </table>
                    </div>

                </div>
                <div class="col-lg-6 align-self pe-lg-4">
                    <!-- /bing maps for Ireland -->
                    <div id='myMap-Ireland' style='height: 40vh;'></div>
                    <!-- //bing maps for Ireland -->
                </div>

            </div>
        </div>
    </section>
    <!--//Location Distribution of Each Site-->

    <script type='text/javascript'>
        function loadMapScenario() {
            var map = new Microsoft.Maps.Map(document.getElementById('myMap-Ireland'), {
                {# latitude, longitude#}
                center: new Microsoft.Maps.Location(53.177860260009766, -8.148856163024902),
                zoom: 6,
            });
            {% for row in siteinfo %}
                var pushpin = new Microsoft.Maps.Pushpin(new Microsoft.Maps.Location({{siteinfo| get_v:row | get_v:"Latitude" | floatformat:4}}, {{ siteinfo| get_v:row | get_v:"Longitude" | floatformat:4 }}), {
                    color: '#0267bc',
                    title: '{{ siteinfo| get_v:row | get_v:"Site" }}',
                });
                map.entities.push(pushpin);
            {% endfor %}
        }
    </script>
    <script type='text/javascript'
            src='https://cn.bing.com/api/maps/mapcontrol?branch=experimental&setmkt=zh-cn&key=Am_dTaZgHvrBLrlWbGxhwPilUh-lWZBmzI6Ym2DZhUa0AC7-pnJIg95pPXzPnhsW&callback=loadMapScenario'
            async defer>
    </script>

    <!-- /charts -->
    <section class="w3l-servicesblock w3l-servicesblock1 py-5" id="progress">
        <div class="container py-lg-5 py-md-4 py-2">
            <div class="row">
                <div class="col-lg-6 mb-lg-0 mb-5 pe-lg-5">
                    <h6 class="title-subw3hny mb-1">Line Graphs</h6>
                    <h3 class="title-w3l">潮位观测</h3>
                    <p class="mt-md-4 mt-3">我们使用echarts绘制了上述站点的潮位观测序列图，您可以选择感兴趣的站点，以查看它们的数据变化趋势。实验数据均经过质量控制，时间跨度为2017年1月1日至2017年3月31日，记录间隔为6min。
                    </p>
                    <!-- action是提交的位置，其实就是一个url -->
                    <select class="form-select form-select-lg mb-3" id="choose-site-select">
                        {% for row in siteinfo %}
                            <option value="{{ row }}">{{ siteinfo| get_v:row | get_v:"Site" }}</option>
                        {% endfor %}
                    </select>
                    <input class="btn btn-primary" type="submit" value="查询" id="choose-site-btn">
                </div>

                <div class="col-lg-6 align-self pe-lg-4" id="echarts-tidal-series" style="height: 60vh;">
                    {#                <div class="col-lg-6 align-self pe-lg-4" id="echarts-tidal-series" style="width: 800px;height:600px;">#}
                </div>

            </div>
        </div>
    </section>
    <!-- //charts -->

    <!-- prediction API section -->
    <section class="w3services-3">
        <div class="py-5">
            <div class="container py-lg-5 py-md-4 py-2">
                <div class="mx-auto">
                    <h6 class="title-subw3hny mb-1">Tidal Prediction</h6>
                    <h3 class="title-w3l mb-3">潮位预测</h3>
                    <p class="mt-md-4 mt-3">以Howth Harbour为例，我们训练部署了组合模型。在此提供调用模型的API以预测Howth Harbour的潮位。
                        用户可以输入十个时间步的潮汐水位数据（即一小时内的数据观测），来预测下一时间步的潮位值。
                        我们在下面提供了50个样例供用户进行测试实验，您可以直接复制其中一行的10个时间步数据，粘贴到输入框进行预测，再与Target值进行比对。
                    </p>
                </div>
                <div class="mt-md-4 mt-3">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th scope="col">#</th>
                            {% for o in ''|rjust:10 %}
                                <th scope="col">Timestep{{ forloop.counter }}</th>
                            {% endfor %}
                            <th scope="col">Target</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for row in examples %}
                            <tr>
                                <th scope="row">{{ forloop.counter }}</th>
                                {% for col in examples_columns %}
                                    <td>{{ examples | get_v:row | get_v:col | floatformat:3 }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="input-group">
                    <span class="input-group-text">请输入10个时间步的潮汐水位值，<br>以,或者Tab键分隔</span>
                    <textarea class="form-control" aria-label="With textarea" id="input-seq"></textarea>
                </div>
                <div class="mt-md-4 mt-3">
                    <p><span><input class="btn btn-primary" type="submit" value="点击预测" id="prediction-btn"></span>
                        使用我们的组合模型对下一个时间步的潮汐水位值进行预测，其结果为：</p>
                    <p id="prediction-result" style="font-weight: bold"></p>
                </div>
            </div>
        </div>
    </section>
    <!--//prediction API section -->
{% endblock %}

{% block js %}
    <!-- 导航栏激活 -->
    <script>
        $("#link-dashboard").addClass("active")
    </script>

    <!-- echarts绘图 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.1/dist/echarts.min.js"></script>
    <script type="text/javascript">
        function LineGraph(json_data) {
            var series_data = json_data['Water_Level_LAT'];
            var list_timestamp = Object.keys(series_data);
            {#console.log(list_timestamp)#}
            var list_value = Object.values(series_data);
            {#console.log(list_value)#}
            // 基于准备好的dom，初始化echarts实例
            var myChart = echarts.init(document.getElementById('echarts-tidal-series'));
            // 指定图表的配置项和数据
            var option = {
                title: {
                    text: "潮汐观测序列图",
                    left: 'center'
                },
                xAxis: {
                    data: list_timestamp,
                },
                yAxis: {
                    type: 'value',
                    name: "水位高度",
                    axisLabel: {
                        formatter: '{value} m'
                    },
                },
                series: [
                    {
                        data: list_value,
                        type: 'line',
                        showSymbol: false,
                    }
                ],
                dataZoom: { // 放大和缩放
                    type: 'inside'
                },
            };

            // 使用刚指定的配置项和数据显示图表。
            myChart.setOption(option);
        }
    </script>

    <!-- 获得预测值并更新页面 -->
    <script type="text/javascript">
        function TidalPrediction(json_data) {
            var input_seq = json_data["prediction_result"];
            //更新结果的值
            $("#prediction-result").text(input_seq+"m")
        }
    </script>

    <!-- Ajax异步 -->
    <!-- 妈的，这个回调是真麻烦，没有flask好用 -->
    <script>
        //加载完页面DOM元素后要执行的函数
        $(document).ready(
            function () {
                $("#choose-site-btn").on("click", function () {
                    $.ajax({
                        url: "echarts", //相当于form表单里的action，把参数提交到echarts路由
                        type: "GET",
                        data: {
                            "choose-site": $("#choose-site-select").val(),
                        },
                        success: function (data) {
                            LineGraph(data)
                        },
                        error: function () {
                            console.log('Failed to Draw Line Graphs!')
                        }
                    })
                });
                $("#prediction-btn").on("click", function () {
                    $.ajax({
                        url: "prediction",
                        type: "GET",
                        data: {
                            {# url的参数名称 #}
                            "input-seq": $("#input-seq").val(),
                        },
                        success: function (data) {
                            TidalPrediction(data)
                        },
                        error: function () {
                            console.log('Failed to Get Tidal Prediction!')
                        }
                    })
                })


            }
        )
    </script>
{% endblock %}
